name: Auto bump flake.lock
on:
  schedule:
    - cron: "0 6 1,16 * *"
  workflow_dispatch:
concurrency:
  group: bump-flake-lock
  cancel-in-progress: true
permissions:
  contents: write
jobs:
  bump:
    name: Bump flake.lock
    runs-on: ubuntu-latest
    steps:
      # 1) Set up QEMU FIRST (while Docker still exists) â­ MOVED UP
      - name: Set up QEMU for multi-arch
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # 2) Free up disk space for Nix (this removes Docker)
      - name: Nothing but Nix (reclaim disk space for /nix)
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: "cleave"

      # 2) Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3) Install Nix with experimental features + ARM support
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes pipe-operators
            extra-platforms = aarch64-linux
            extra-system-features = nixos-test benchmark big-parallel kvm
      # 4) Show free space & git status
      - name: Show free space & git status
        run: |
          df -h
          git --version
          git status --porcelain --untracked-files=no || true
      # 5) Try full update first
      - name: Update all flake inputs
        id: full-update
        continue-on-error: true
        run: |
          git checkout main || git checkout -b main
          nix flake update
          git --no-pager diff flake.lock || true
      # 6) Check flake after full update
      - name: Check flake (full update)
        id: full-check
        if: steps.full-update.outcome == 'success'
        continue-on-error: true
        run: |
          nix flake check --all-systems
      # 7) If full update failed, rollback and try nixpkgs + nixpkgs-unstable
      - name: Rollback and update nixpkgs + nixpkgs-unstable
        id: dual-update
        if: steps.full-check.outcome == 'failure'
        continue-on-error: true
        run: |
          echo "Full update failed flake check, trying nixpkgs + nixpkgs-unstable update..."
          git restore flake.lock
          nix flake update nixpkgs nixpkgs-unstable
          git --no-pager diff flake.lock || true
      # 8) Check flake after nixpkgs + nixpkgs-unstable update
      - name: Check flake (nixpkgs + nixpkgs-unstable)
        id: dual-check
        if: steps.full-check.outcome == 'failure' && steps.dual-update.outcome == 'success'
        continue-on-error: true
        run: |
          nix flake check --all-systems
      # 9) If nixpkgs + nixpkgs-unstable failed, rollback and try nixpkgs only
      - name: Rollback and update nixpkgs only
        if: steps.dual-check.outcome == 'failure'
        run: |
          echo "nixpkgs + nixpkgs-unstable update failed flake check, trying nixpkgs only..."
          git restore flake.lock
          nix flake update nixpkgs
          git --no-pager diff flake.lock || true
      # 10) Check flake after nixpkgs-only update
      - name: Check flake (nixpkgs only)
        id: single-check
        if: steps.dual-check.outcome == 'failure'
        run: |
          nix flake check --all-systems
      # 11) Determine commit message based on what succeeded
      - name: Set commit message
        id: commit-msg
        run: |
          if [ "${{ steps.full-check.outcome }}" == "success" ]; then
            echo "message=chore(deps): update flake.lock (all inputs)" >> $GITHUB_OUTPUT
          elif [ "${{ steps.dual-check.outcome }}" == "success" ]; then
            echo "message=chore(deps): update flake.lock (nixpkgs + nixpkgs-unstable)" >> $GITHUB_OUTPUT
          else
            echo "message=chore(deps): update flake.lock (nixpkgs only)" >> $GITHUB_OUTPUT
          fi
      # 12) Commit & push (only runs if at least one check succeeds)
      - name: Commit and push flake.lock
        if: steps.full-check.outcome == 'success' || steps.dual-check.outcome == 'success' || steps.single-check.outcome == 'success'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ steps.commit-msg.outputs.message }}
          branch: main
          commit_options: "--no-verify --signoff"
          file_pattern: flake.lock
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          skip_dirty_check: false
          skip_fetch: false
          pull_options: '--rebase'