name: Auto bump flake.lock
on:
  schedule:
    - cron: '0 0 1 * *' # 00:00 UTC on the 1st of every month
  workflow_dispatch:

concurrency:
  group: bump-flake-lock
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  bump:
    name: Bump flake.lock
    runs-on: ubuntu-latest
    steps:
      # 1) Free up disk space for Nix specifically
      - name: Nothing but Nix (reclaim disk space for /nix)
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'cleave'  # Options: holster, carve, cleave (default), rampage
      
      # 2) Checkout repository
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # 3) Install Nix
      - name: Install Nix
        uses: cachix/install-nix-action@v20
      
      # 4) Show free space & git status
      - name: Show free space & git status
        run: |
          df -h
          git --version
          git status --porcelain --untracked-files=no || true
      
      # 5) Update flake.lock
      - name: Update flake.lock
        run: |
          git checkout main || git checkout -b main
          nix flake update
          git --no-pager diff --name-only || true
      
      # 6) Commit & push
      - name: Commit and push flake.lock
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit_message: 'Bump flake.lock'
          branch: main
          commit_options: '--no-verify --signoff'
          file_pattern: flake.lock
          commit_user_name: 'Flake Bot'
          commit_author: 'Flake Bot <actions@github.com>'
          skip_dirty_check: false
          skip_fetch: true